/// RISC-V execution environment interface
package eei {
    const XLEN  : u32 = 64;
    const ILEN  : u32 = 32;
    const IALIGN: u32 = 16;

    type UIntX  = logic       <XLEN>;
    type UInt32 = logic       <32>  ;
    type UInt64 = logic       <64>  ;
    type SIntX  = signed logic<XLEN>;
    type SInt32 = signed logic<32>  ;
    type SInt64 = signed logic<64>  ;
    type Inst   = logic       <ILEN>;
    type Addr   = logic       <XLEN>;

    // memory
    const MEMBUS_DATA_WIDTH: u32 = 64;

    // RAM
    const RAM_ADDR_WIDTH: u32  = 20;
    const RAM_DATA_WIDTH: u32  = 64;
    const MMAP_RAM_BEGIN: Addr = 'h8000_0000 as Addr;

    // ROM
    const ROM_ADDR_WIDTH: u32  = 9;
    const ROM_DATA_WIDTH: u32  = 64;
    const MMAP_ROM_BEGIN: Addr = 'h1000 as Addr;
    const MMAP_ROM_END  : Addr = MMAP_ROM_BEGIN + 'h3ff as Addr;

    // ACLINT
    const MMAP_ACLINT_BEGIN   : Addr = 'h200_0000 as Addr;
    const MMAP_ACLINT_MSIP    : Addr = 0;
    const MMAP_ACLINT_MTIMECMP: Addr = 'h4000 as Addr;
    const MMAP_ACLINT_MTIME   : Addr = 'h7ff8 as Addr;
    const MMAP_ACLINT_SETSSIP : Addr = 'h8000 as Addr;
    const MMAP_ACLINT_END     : Addr = MMAP_ACLINT_BEGIN + 'hbfff as Addr;

    // UART (16550)
    const MMAP_UART_BEGIN: Addr = 'h1000_0000 as Addr;
    const MMAP_UART_END  : Addr = MMAP_UART_BEGIN + 'h3ff as Addr;

    // pc on reset
    const INITIAL_PC: Addr = MMAP_ROM_BEGIN;

    // opcode
    const OP_LUI      : logic<7> = 7'b0110111;
    const OP_AUIPC    : logic<7> = 7'b0010111;
    const OP_OP       : logic<7> = 7'b0110011;
    const OP_OP_IMM   : logic<7> = 7'b0010011;
    const OP_OP_32    : logic<7> = 7'b0111011;
    const OP_OP_IMM_32: logic<7> = 7'b0011011;
    const OP_JAL      : logic<7> = 7'b1101111;
    const OP_JALR     : logic<7> = 7'b1100111;
    const OP_BRANCH   : logic<7> = 7'b1100011;
    const OP_LOAD     : logic<7> = 7'b0000011;
    const OP_STORE    : logic<7> = 7'b0100011;
    const OP_SYSTEM   : logic<7> = 7'b1110011;
    const OP_MISC_MEM : logic<7> = 7'b0001111;
    const OP_AMO      : logic<7> = 7'b0101111;

    // A Extension
    enum AMOOp: logic<5> {
        LR = 5'b00010,
        SC = 5'b00011,
        SWAP = 5'b00001,
        ADD = 5'b00000,
        XOR = 5'b00100,
        AND = 5'b01100,
        OR = 5'b01000,
        MIN = 5'b10000,
        MAX = 5'b10100,
        MINU = 5'b11000,
        MAXU = 5'b11100,
    }

    enum PrivMode: logic<2> {
        M = 2'b11,
        S = 2'b01,
        U = 2'b00,
    }

    /// CSR Address
    enum CsrAddr: logic<12> {
        // ====================================================
        // * Machine Information Registers
        // ====================================================
        // MVENDORID = 12'hf11, /// Vendor ID
        // MARCHID = 12'hf12, /// Architecture ID
        MIMPID = 12'hf13, /// Implementation ID
        MHARTID = 12'hf14, /// Hardware thread ID
        // MCONFIGPTR = 0xf15, /// Pointer to configuration data structure

        // ====================================================
        // * Machine Trap Setup
        // ====================================================
        MSTATUS = 12'h300, /// Machine status register
        MISA = 12'h301, /// ISA and extensions
        MEDELEG = 12'h302, /// Machine exception delegation register
        MIDELEG = 12'h303, /// Machine interrupt delegation register
        MIE = 12'h304, /// Machine interrupt-enable register
        MTVEC = 12'h305, /// Machine trap-handler base address
        MCOUNTEREN = 12'h306, // Machine counter enable
        // MSTATUSH = 12'h310, /// Additional machine status register, RV32 only
        // MEDELEGH = 12'h312, /// Upper 32 bits of medeleg, RV32 only

        // ====================================================
        // * Machine Trap Handling
        // ====================================================
        MSCRATCH = 12'h340, /// Scratch register for machine trap handlers
        MEPC = 12'h341, /// Machine exception program counter
        MCAUSE = 12'h342, /// Machine trap cause
        MTVAL = 12'h343, /// Machine bad address or instruction
        MIP = 12'h344, /// Machine interrupt pending
        // MTINST = 12'h34a, /// Machine trap instruction (transformed)
        // MTVAL2 = 12'h34b, /// Machine bad guest physical address

        // ====================================================
        // * Machine Configuration
        // ====================================================

        // ====================================================
        // * Machine Memory Protection
        // ====================================================

        // ====================================================
        // * Machine State Enable Registers
        // ====================================================

        // ====================================================
        // * Machine Non-Maskable Interrupt Handling
        // ====================================================

        // ====================================================
        // * Machine Counter/Timers
        // ====================================================
        MCYCLE = 12'hB00, /// Machine cycle counter
        MINSTRET = 12'hB02, /// Machine instructions-retired counter

        // ====================================================
        // * Machine Counter Setup
        // ====================================================

        // ====================================================
        // * Debug/Trace Registers (shared with Debug Mode)
        // ====================================================

        // ====================================================
        // * Debug Mode Registers
        // ====================================================

        // ====================================================
        // * Custom
        // ====================================================
        LED = 12'h800,
    }

    // Machine Implementation ID
    const MACHINE_IMPLEMENTATION_ID: UIntX = 1;

    // wmasks
    const MSTATUS_WMASK : UIntX = 'h0000_0000_0000_0000 as UIntX;
    const MTVEC_WMASK   : UIntX = 'hffff_ffff_ffff_fffc;
    const MSCRATCH_WMASK: UIntX = 'hffff_ffff_ffff_ffff;
    const MEPC_WMASK    : UIntX = 'hffff_ffff_ffff_fffe;
    const MCAUSE_WMASK  : UIntX = 'hffff_ffff_ffff_ffff;
    const MTVAL_WMASK   : UIntX = 'hffff_ffff_ffff_ffff;
    const LED_WMASK     : UIntX = 'hffff_ffff_ffff_ffff;

    enum CsrCause: UIntX {
        INSTRUCTION_ADDRESS_MISALIGNED = 0,
        ILLEGAL_INSTRUCTION = 2,
        BREAKPOINT = 3,
        LOAD_ADDRESS_MISALIGNED = 4,
        STORE_AMO_ADDRESS_MISALIGNED = 6,
        ENVIRONMENT_CALL_FROM_M_MODE = 11,
        SUPERVISOR_SOFTWARE_INTERRUPT = 'h8000_0000_0000_0001,
        MACHINE_SOFTWARE_INTERRUPT = 'h8000_0000_0000_0003,
        SUPERVISOR_TIMER_INTERRUPT = 'h8000_0000_0000_0005,
        MACHINE_TIMER_INTERRUPT = 'h8000_0000_0000_0007,
        SUPERVISOR_EXTERNAL_INTERRUPT = 'h8000_0000_0000_0009,
        MACHINE_EXTERNAL_INTERRUPT = 'h8000_0000_0000_000b,
    }
}
